!function(e){var t=(new Date).getTime(),n="completed",s=function(){this._defaults={styleClass:{panelClass:"completed-panel",inputClass:"completed-input",ckClass:"completed-ck"},separator:","},this._settingsDataFormat={}};e.extend(s.prototype,{_attach:function(t,s){t.id||(this.uuid++,t.id="dp"+this.uuid);var a=this._newInst(e(t));a.settings=e.extend({buttonText:"选择"},s||{}),e.data(t,n,a),this._init(t)},_newInst:function(e){var t=e[0].id.replace(/([^A-Za-z0-9_])/g,"\\\\$1");return{id:t}},_getInst:function(t){try{return e.data(t,n)}catch(s){throw"Missing instance data for this completed"}},_destroyCompleted:function(){},_init:function(t){var n=this._getInst(t),s=n.id,a=n.settings;this._buildHTML(s,a),e(document).click(function(t){t.target.id!==s&&e("#"+s+"SelectedPanel").hide()}),this._buildCheckboxPanel(s,a.data)},_buildHTML:function(t,n){var s=n.height+"px",a=this._getDefaults(e.completed._defaults,n,"styleClass"),l=e("#"+t),i="<button onclick=\"$('#"+t+"CheckboxPanel').toggle()\">"+n.buttonText+"</button><div id='"+t+"SelectedPanel' class='"+a.panelClass+"' style='height:"+s+";'></div><div class='none "+a.ckClass+"' id='"+t+"CheckboxPanel'><div>";n.data.sort(),l.after(i).bind("keyup",{settings:n},this._keyupAction).bind("keydown",function(e){n.chinese=e.keyCode}).addClass(a.inputClass).width(l.width()-78);var o=e("#"+t+"SelectedPanel");n.tipNum=0,o.width(l.width()+2)},_keyupAction:function(t){var n=t.data.settings,s=e.completed._getCurrentWord(this,n);if(""===s.currentWord||27===t.keyCode||16===t.keyCode||16===t.keyCode)return e("#"+this.id+"SelectedPanel").hide(),void(n.tipNum=0);var a=e.completed._getMatchData(n.data,this.value,s.currentWord);if(38===t.keyCode&&(n.tipNum>0?n.tipNum--:n.tipNum=a.length-1),40===t.keyCode&&(n.tipNum<a.length-1?n.tipNum++:n.tipNum=0),e.completed._buildSelectedPanel(this.id,a,n,s.currentWord),13===t.keyCode&&a[n.tipNum]&&229!==n.chinese){var l=this.value;this.value=l.substring(0,s.startPos)+a[n.tipNum]+l.substring(s.endPos,l.length),e("#"+this.id+"SelectedPanel").hide(),n.chinese=void 0}38!==t.keyCode&&40!==t.keyCode&&(n.tipNum=0)},_getCurrentWord:function(t,n){var s=e(t).val(),a=!0,l=0,i=0,o=e.completed._defaults.separator;if(""===s)return{currentWord:"",startPos:i,endPos:l};if(document.selection)try{var c=document.selection.createRange(),r=t.createTextRange();r.collapse(!0),r.select();var d=document.selection.createRange();d.setEndPoint("EndToEnd",c),n.curPos=d.text.length,c.select()}catch(u){delete u}else n.curPos=t.selectionStart;for(var h=n.curPos,p=0;p<s.length;p++)s.charAt(p)===o&&p>=h&&a&&(l=p,a=!1);a===!0&&(a=!1,l=s.length);for(var m=l;m>-1;m--)s.charAt(m)===o&&h>m&&!a&&(i=m+1,a=!0);return{currentWord:s.substring(i,l),startPos:i,endPos:l}},_getMatchData:function(t,n,s){for(var a=n.split(e.completed._defaults.separator),l=[],i=0;i<t.length;i++)if("number"==typeof t[i]&&(t[i]=t[i].toString()),t[i].toLowerCase().indexOf(s.toLowerCase())>-1){for(var o=!0,c=0;c<a.length;c++)t[i]===a[c].toString()&&t[i].toLowerCase()!==s.toLowerCase()&&(o=!1);o&&l.push(t[i])}return l},_mousemoveSelectPanel:function(t,n,s){e(t).parent().find("a").removeClass("selected"),t.className="selected";var a=e.completed._getInst(document.getElementById(s));a.settings.tipNum=n},_buildSelectedPanel:function(t,n,s,a){var l=e("#"+t+"SelectedPanel");if(0===n.length)return void l.html("").hide();s.tipNum>=n.length&&(s.tipNum=0);for(var i="",o=0;o<n.length;o++){var c="",r=n[o].replace(a,"<b>"+a+"</b>");s.tipNum===o&&(c="class='selected'"),i+="<a href='javascript:void(0);'                                         onmousemove=\"$.completed._mousemoveSelectPanel(this, "+o+", '"+t+"');\"                                        "+c+">"+r+"</a>"}l.html(i).show();var d=e("#"+t+"SelectedPanel a.selected");d.position().top+l.scrollTop()>50-d.height()&&l.scrollTop(d.position().top+l.scrollTop()+d.height()-50),d.position().top<0&&l.scrollTop(l.scrollTop-d.height()),e("#"+t+"SelectedPanel a").click(function(){var n=document.getElementById(t),a=e.completed._getCurrentWord(document.getElementById(t),s),l=e.completed._getMatchData(s.data,n.value,a.currentWord),i=n.value;n.value=i.substring(0,a.startPos)+l[s.tipNum]+i.substring(a.endPos,i.length),s.tipNum=0,e(n).focus()})},_buildCheckboxPanel:function(t,n){for(var s="",a=e("#"+t),l=0;l<n.length;l++)s+="<span>"+n[l]+"</span>";e("#"+t+"CheckboxPanel").html(s+"<div class='clear'></div>"),e("#"+t+"CheckboxPanel span").click(function(){var e=a.val(),t=this.innerHTML;if("selected"===this.className){this.className="";var n=e.substr(e.indexOf(t)+t.length,1);t===e||","!==n?a.val(e.replace(t,"")):a.val(e.replace(t+",",""))}else this.className="selected",""===e.replace(/\s/g,"")||","===e.substr(e.length-1,1)?a.val(e+t):a.val(e+","+t)}),this._matchChecked(t),a.blur(function(){e.completed._matchChecked(t)})},_matchChecked:function(t){var n=e("#"+t).val().split(",");e("#"+t+"CheckboxPanel span").removeClass().each(function(){for(var e=0;e<n.length;e++)this.innerHTML===n[e]&&(this.className="selected")})},_getDefaults:function(e,t,n){if("styleClass"===n){if("default"===t.theme||void 0===t.theme)return e.styleClass;t.styleClass={};for(var s in e[n])t.styleClass[s]=t.theme+"-"+e.styleClass[s]}else{if("height"===n||"width"===n)return null===t[n]||void 0===t[n]?"auto":t[n]+"px";if(null===t[n]||void 0===t[n])return e[n]}return t[n]}}),e.fn.completed=function(t){var n=Array.prototype.slice.call(arguments);return this.each(function(){"string"==typeof t?e.completed["_"+t+"Completed"].apply(e.completed,[this].concat(n)):e.completed._attach(this,t)})},e.completed=new s,window["DP_jQuery_"+t]=e}(jQuery);