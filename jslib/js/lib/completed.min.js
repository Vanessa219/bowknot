!function(e){var t=(new Date).getTime(),n="completed",a=function(){this._defaults={styleClass:{panelClass:"completed-panel",inputClass:"completed-input",ckClass:"completed-ck"},separator:","},this._settingsDataFormat={}};e.extend(a.prototype,{_attach:function(t,a){t.id||(this.uuid++,t.id="dp"+this.uuid);var s=this._newInst(e(t));s.settings=e.extend({buttonText:"选择"},a||{}),e.data(t,n,s),this._init(t)},_newInst:function(e){var t=e[0].id.replace(/([^A-Za-z0-9_])/g,"\\\\$1");return{id:t}},_getInst:function(t){try{return e.data(t,n)}catch(a){throw"Missing instance data for this completed"}},_destroyCompleted:function(){},_init:function(t){var n=this._getInst(t),a=n.id,s=n.settings;this._buildHTML(a,s),e(document).click(function(t){t.target.id!==a&&e("#"+a+"SelectedPanel").hide()}),s.onlySelect||this._buildCheckboxPanel(a,s.data)},_buildHTML:function(t,n){var a=n.height+"px",s=this._getDefaults(e.completed._defaults,n,"styleClass"),l=e("#"+t),i="";n.onlySelect||(i+="<button onclick=\"$('#"+t+"CheckboxPanel').toggle()\">"+n.buttonText+"</button>"),i+="<div id='"+t+"SelectedPanel' class='"+s.panelClass+"' style='height:"+a+";'></div><div class='none "+s.ckClass+"' id='"+t+"CheckboxPanel'><div>","object"==typeof n.data&&n.data.sort(),l.after(i).bind("keyup",{settings:n},this._keyupAction).bind("keydown",function(e){n.chinese=e.keyCode}).addClass(s.inputClass).width(l.width()-78);var o=e("#"+t+"SelectedPanel");n.tipNum=0,o.width(l.width()+2)},_keyupAction:function(t){var n=t.data.settings,a=e.completed._getCurrentWord(this,n);if(""===a.currentWord||27===t.keyCode||16===t.keyCode||16===t.keyCode)return e("#"+this.id+"SelectedPanel").hide(),n.tipNum=0,void(n.afterKeyup?n.afterKeyup(t):"");var s=e.completed._getMatchData(n.data,this.value,a.currentWord);if(38===t.keyCode&&(n.tipNum>0?n.tipNum--:n.tipNum=s.length-1),40===t.keyCode&&(n.tipNum<s.length-1?n.tipNum++:n.tipNum=0),e.completed._buildSelectedPanel(this.id,s,n,a.currentWord),13===t.keyCode&&s[n.tipNum]&&229!==n.chinese){var l=this.value;this.value=l.substring(0,a.startPos)+s[n.tipNum]+l.substring(a.endPos,l.length),e("#"+this.id+"SelectedPanel").hide(),n.chinese=void 0}38!==t.keyCode&&40!==t.keyCode&&(n.tipNum=0),n.afterKeyup?n.afterKeyup(t):""},_getCurrentWord:function(t,n){var a=e(t).val(),s=!0,l=0,i=0,o=e.completed._defaults.separator;if(""===a)return{currentWord:"",startPos:i,endPos:l};if(document.selection)try{var c=document.selection.createRange(),r=t.createTextRange();r.collapse(!0),r.select();var d=document.selection.createRange();d.setEndPoint("EndToEnd",c),n.curPos=d.text.length,c.select()}catch(u){delete u}else n.curPos=t.selectionStart;for(var h=n.curPos,p=0;p<a.length;p++)a.charAt(p)===o&&p>=h&&s&&(l=p,s=!1);s===!0&&(s=!1,l=a.length);for(var m=l;m>-1;m--)a.charAt(m)===o&&h>m&&!s&&(i=m+1,s=!0);return{currentWord:a.substring(i,l),startPos:i,endPos:l}},_getMatchData:function(t,n,a){for(var s=n.split(e.completed._defaults.separator),l=[],i=0;i<t.length;i++)if("number"==typeof t[i]&&(t[i]=t[i].toString()),t[i].toLowerCase().indexOf(a.toLowerCase())>-1){for(var o=!0,c=0;c<s.length;c++)t[i]===s[c].toString()&&t[i].toLowerCase()!==a.toLowerCase()&&(o=!1);o&&l.push(t[i])}return l},_mousemoveSelectPanel:function(t,n,a){e(t).parent().find("a").removeClass("selected"),t.className="selected";var s=e.completed._getInst(document.getElementById(a));s.settings.tipNum=n},_buildSelectedPanel:function(t,n,a,s){var l=e("#"+t+"SelectedPanel");if(0===n.length)return void l.html("").hide();a.tipNum>=n.length&&(a.tipNum=0);for(var i="",o=0;o<n.length;o++){var c="",r=n[o].replace(s,"<b>"+s+"</b>");a.tipNum===o&&(c="class='selected'"),i+="<a href='javascript:void(0);'                                         onmousemove=\"$.completed._mousemoveSelectPanel(this, "+o+", '"+t+"');\"                                        "+c+">"+r+"</a>"}l.html(i).show();var d=e("#"+t+"SelectedPanel a.selected");d.position().top+l.scrollTop()>50-d.height()&&l.scrollTop(d.position().top+l.scrollTop()+d.height()-50),d.position().top<0&&l.scrollTop(l.scrollTop-d.height()),e("#"+t+"SelectedPanel a").click(function(){var n=document.getElementById(t),s=e.completed._getCurrentWord(document.getElementById(t),a),l=e.completed._getMatchData(a.data,n.value,s.currentWord),i=n.value;n.value=i.substring(0,s.startPos)+l[a.tipNum]+i.substring(s.endPos,i.length),a.tipNum=0,e(n).focus(),a.afterSelected?a.afterSelected(e(this)):""})},_buildCheckboxPanel:function(t,n){for(var a="",s=e("#"+t),l=0;l<n.length;l++)a+="<span>"+n[l]+"</span>";e("#"+t+"CheckboxPanel").html(a+"<div class='clear'></div>"),e("#"+t+"CheckboxPanel span").click(function(){var e=s.val(),t=this.innerHTML;if("selected"===this.className){this.className="";var n=e.substr(e.indexOf(t)+t.length,1);t===e||","!==n?s.val(e.replace(t,"")):s.val(e.replace(t+",",""))}else this.className="selected",""===e.replace(/\s/g,"")||","===e.substr(e.length-1,1)?s.val(e+t):s.val(e+","+t)}),this._matchChecked(t),s.blur(function(){e.completed._matchChecked(t)})},_matchChecked:function(t){var n=e("#"+t).val().split(",");e("#"+t+"CheckboxPanel span").removeClass().each(function(){for(var e=0;e<n.length;e++)this.innerHTML===n[e]&&(this.className="selected")})},_updateDataCompleted:function(t,n,a){var s=this._getInst(t),l=s.id,i=s.settings;i.data=a,e.completed._buildSelectedPanel(l,a,i,"2011")},_getDefaults:function(e,t,n){if("styleClass"===n){if("default"===t.theme||void 0===t.theme)return e.styleClass;t.styleClass={};for(var a in e[n])t.styleClass[a]=t.theme+"-"+e.styleClass[a]}else{if("height"===n||"width"===n)return null===t[n]||void 0===t[n]?"auto":t[n]+"px";if(null===t[n]||void 0===t[n])return e[n]}return t[n]}}),e.fn.completed=function(t){var n=Array.prototype.slice.call(arguments);return this.each(function(){"string"==typeof t?e.completed["_"+t+"Completed"].apply(e.completed,[this].concat(n)):e.completed._attach(this,t)})},e.completed=new a,window["DP_jQuery_"+t]=e}(jQuery);