/*
 * Copyright (C) 2011, Liyuan Li
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
(function(a){a.fn.extend({tabs:{version:"0.0.1.6",author:"lly219@gmail.com"}});var b=(new Date).getTime(),c="tabs",d=function(){this._defaults={styleClass:{leftSelected:"tabs-left-selected",rightSelected:"tabs-right-selected",left:"tabs-left",right:"tabs-right",leftSelectedRight:"tabs-left-selected-right",leftRight:"tabs-left-right",leftRightSelected:"tabs-left-right-selected",middle:"tabs-middle",middleSelected:"tabs-middle-selected",nav:"tabs-nav",content:"tabs-content",tabsBG:"tabs-tabs-bg",closeIcon:"tabs-close-icon",hover:"tabs-hover"}}};a.extend(d.prototype,{_attach:function(b,d){b.id||(this.uuid++,b.id="dp"+this.uuid);var e=this._newInst(a(b));e.settings=a.extend({length:0},d||{}),a.data(b,c,e),this._init(b)},_newInst:function(a){var b=a[0].id.replace(/([^A-Za-z0-9_])/g,"\\\\$1");return{id:b}},_getInst:function(b){try{return a.data(b,c)}catch(d){throw"Missing instance data for this tabs"}},_init:function(b){var c=this._getInst(b),d=c.id,e=c.settings,f=this._getDefaults(this._defaults,e,"styleClass"),g=undefined;b.className=f.tabsBG;if(e.data){var h=e.height?" style='height:"+e.height+"px;'":"";b.innerHTML="<ul class='"+f.nav+"'></ul>",a(b).after("<div id='"+d+"Content' class='"+f.content+"'"+h+"></div>"),this._buildHTML(b),g=a(b).find("li")}else{g=a(b).find("li"),e.data=[],a(b).find("ul").addClass(f.nav);var i=a("#"+d+"Content div"),j=a("#"+d+"Content");j.addClass(f.content),e.height&&j.height(e.height);for(var k=0;k<g.length;k++)e.data[k]={},e.data[k].text=g.get(k).innerHTML,e.data[k].content=i.get(k).innerHTML,e.data[k].id=a(g.get(k).children[0]).data("index"),k!==g.length-1?g.get(k).innerHTML="<div></div>"+g.get(k).innerHTML:g.get(k).innerHTML="<div></div>"+g.get(k).innerHTML+"<div></div>"}this._setCurrentTab(b,e.data[0].id),this._changeTab(b,g),this._close(b,g),this._bindEvent(b,g),typeof e.load=="function"&&e.load()},_buildHTML:function(b){var c=this._getInst(b),d=c.settings,e=c.id,f=d.data,g="",h="";for(var i=0;i<f.length;i++){var j={};j=this._buildTabPanelHTML(b,f[i]),g+=j.tabHTML,h+=j.contentHTML}a(b).find("ul").html(g),a("#"+e+"Content").html(h)},_buildTabPanelHTML:function(a,b){var c=this._getInst(a),d=c.settings,e=c.id,f=this._getDefaults(this._defaults,d,"styleClass"),g=d.data,h="",i="",j="",k=b.text,l=b.alt?b.alt:b.text;b.altCount&&b.altCount<k.length&&k.indexOf("</")<0&&(k=k.substr(0,b.altCount)+"..."),k+=b.button?"<span id='"+e+"_"+b.id+"_button'>"+b.button+"</span>":"",g[g.length-1].id===b.id.toString()&&(j="<div></div>"),b.isClose?h="<li><div></div><div data-index='"+b.id+"' title='"+l+"'><span class='left'>"+k+"</span><a  href='javascript:void(0);' class='"+f.closeIcon+"'></a></div>"+j+"</li>":h="<li><div></div><div data-index='"+b.id+"' title='"+l+"'>"+k+"</div>"+j+"</li>";var m=e+"_"+b.id,n=b.content;if(b.url){var o=this._calculateIframeHeight(d.height,e);n="<iframe id='"+m+"_iframe' src='"+b.url+"' frameborder='0' width='100%' height='"+o+"' style='height:"+o+";'></iframe>"}i="<div id='"+m+"'>"+n+"</div>";return{tabHTML:h,contentHTML:i}},_changeTab:function(b,c,d){d!==undefined?a(c.get(d)).bind("click",function(){a.tabs._changeTabFunction(this,b)}).mouseover(function(){this.className="hover"}).mouseout(function(){this.className=""}):c.each(function(){a(this).bind("click",function(){a.tabs._changeTabFunction(this,b)})}).mouseover(function(){this.className="hover"}).mouseout(function(){this.className=""})},_changeTabFunction:function(b,c){var d=this._getInst(c),e=this._getDefaults(this._defaults,d.settings,"styleClass"),f=a(a(b).find("div")[1]);f.hasClass(e.middleSelected)||this._setCurrentTab(c,f.data("index"))},_setCurrentTab:function(b,c){var d=this._getInst(b),e=d.settings,f=e.data,g=this._getDefaults(this._defaults,e,"styleClass"),h=a(b).find("li");for(var i=0;i<f.length;i++){var j=a("#"+b.id+"_"+f[i].id);a("#"+d.id+"_"+f[i].id+"_button").hide(),c.toString()===f[i].id?(i===0?(h.get(i).children[0].className=g.leftSelected,f.length===1&&(h.get(i).children[2].className=g.rightSelected)):i===f.length-1?(h.get(i).children[0].className=g.leftRightSelected,h.get(i).children[2].className=g.rightSelected):h.get(i).children[0].className=g.leftRightSelected,h.get(i).children[1].className=g.middleSelected,f[i].reload&&!f[i].content&&(document.getElementById(f[i].id+"Iframe").contentWindow.location.href=f[i].url),j.show(),a("#"+d.id+"_"+f[i].id+"_button").show()):(i===0?h.get(i).children[0].className=g.left:(c.toString()===f[i-1].id?h.get(i).children[0].className=g.leftSelectedRight:h.get(i).children[0].className=g.leftRight,i===f.length-1&&(h.get(i).children[2].className=g.right)),h.get(i).children[1].className=g.middle,j.hide())}},_bindEvent:function(b,c,d){var e=this._getInst(b),f=e.settings,g=f.bind,h=f.data;if(f.bind)if(d!==undefined)for(var i=0;i<g.length;i++)a(c.get(d)).bind(g[i].type,{data:h[d],index:i},function(a){g[a.data.index].action(a,a.data.data)});else for(var j=0;j<h.length;j++)for(var k=0;k<g.length;k++)a(c.get(j)).bind(g[k].type,{data:h[j],index:k},function(a){g[a.data.index].action(a,a.data.data)})},_close:function(b,c,d){var e=this._getInst(b),f=this._getDefaults(this._defaults,e.settings,"styleClass");d!==undefined?a(c[d]).find("."+f.closeIcon).bind("click",function(c){a.tabs._closeFunction(b,a(c.currentTarget.parentNode).data("index"))}):c.find("."+f.closeIcon).bind("click",function(c){a.tabs._closeFunction(b,a(c.currentTarget.parentNode).data("index"))})},_closeFunction:function(b,c){var d=this._getInst(b),e=d.settings,f=e.data,g=this._getDefaults(this._defaults,d.settings,"styleClass"),h=a(b).find("li"),i=this._getIndexById(f,c.toString());if(typeof e.close!="function"||!!e.close(f[i])){a("#"+b.id+"_"+c).remove();var j=a(a(h.get(i-1)).find("div")[1]);i===f.length-1&&(j.hasClass(g.middleSelected)?j.after("<div class='"+g.rightSelected+"'></div>"):j.after("<div class='"+g.right+"'></div>")),i===f.length-2&&j.hasClass(g.middleSelected)&&(h.get(i+1).children[0].className=g.leftSelectedRight),a(h.get(i)).remove(),f.splice(i,1),a(a(h.get(i)).find("div")[1]).hasClass(g.middleSelected)&&(i===0&&i++,this._setCurrentTab(b,f[i-1].id)),c.currentTarget&&c.stopPropagation()}},_getDefaults:function(a,b,c){if(c==="styleClass"){if(b.theme==="default"||b.theme===undefined)return a.styleClass;b.styleClass={};for(var d in a[c])b.styleClass[d]=a.styleClass[d]+"-"+b.theme}else{if(c==="height"&&b[c]!=="auto"||c==="width")return b[c]===null||b[c]===undefined?a[c]+"px":b[c]+"px";if(b[c]===null||b[c]===undefined)return a[c]}return b[c]},_calculateIframeHeight:function(b,c){var d=a("#"+c+"Content"),e=d.css("padding-top"),f=d.css("padding-bottom");return b-parseInt(e)-parseInt(f)+"px"},_getIndexById:function(a,b){for(var c in a)if(a[c].id===b)return parseInt(c)},_addTabs:function(b,c){var d=this._getInst(b),e=d.settings,f=e.data;c.id=c.id.replace(/(^\s*)|(\s*$)/g,"").toString();var g=f.length;if(typeof e.add=="function"){var h=e.add(c);if(!h)return}if(e.size&&f.length>=e.size)alert("对不起，只能打开"+e.size+"个窗口");else{for(var i=0;i<f.length;i++)if(f[i].id===c.id){this._setCurrentTab(b,c.id);return}e._count++,f.splice(g,0,c),c.id?f[g].id=c.id:f[g].id=d.id+"Content"+e._count;var j=this._buildTabPanelHTML(b,f[g]);f.length-1===g&&a(b).find("ul li div").last().remove(),g===0?a(a(b).find("li").get(g)).before(j.tabHTML):a(a(b).find("li").get(g-1)).after(j.tabHTML),a("#"+d.id+"Content").append(j.contentHTML);var k=a(b).find("li");this._setCurrentTab(b,f[g].id),this._changeTab(b,k,g),this._close(b,k,g),this._bindEvent(b,k,g)}},_lengthTabs:function(a){var b=this._getInst(a);return b.settings.data.length},_selectTabs:function(a,b){this._setCurrentTab(a,b)},_removeTabs:function(b,c){var d=this._getInst(b),e=d.settings,f=this._getDefaults(this._defaults,e,"styleClass"),g=a(b).find("li");e.closeSyn?g.find("#"+c+" ."+f.closeIcon).click():this._closeFunction(b,c)},_getTabTabs:function(b,c,d){var e=this._getInst(b),f=e.settings,g=f.data,h=this._getDefaults(this._defaults,f,"styleClass"),i={},j=0;c?(j=this._getIndexById(g,c),i=g[j]):a(b).find("li").each(function(b){var c=a(this);a(c.find("div")[1]).hasClass(h.middleSelected)&&(i=g[b],j=b)});if(d){j=parseInt(j);switch(d){case"next":j<g.length-1&&(i=g[j+1]);break;case"pre":j>0&&(i=g[j-1]);break;default:alert("get tab error, has no type!")}}return i},_destroyTabs:function(b){var d=a(b),e=this._getInst(b),f=e.settings,g=this._getDefaults(this._defaults,f,"styleClass");a.removeData(b,c),d.removeClass(g.tabsBG).empty(),a("#"+e.id+"Content").remove()},_updateTabs:function(b,c,d){var e=this._getInst(b),f=e.settings,g=a(b).find("li"),h=f.data;if(d===undefined){a.extend(f,c),a("#"+b.id+"Content").height(c.height);var i=f.data;for(var j=0;j<i.length;j++){var k=a("#"+e.id+"_"+i[j].id+"_iframe");i[j].url&&k.length===1&&(k.height(c.height),k.attr("height",c.height))}}else{var l=this._getIndexById(h,d),m=c.altCount?c.altCount:h[l].altCount,n=c.url?c.url:h[l].url,o=c.text?c.text:h[l].text,p=o,q=a("#"+e.id+"_"+h[l].id);m<o.length&&o.indexOf("</")<0&&(o=o.substr(0,m)+"..."),h[l].close?a(a(g[l]).find("span")[0]).html(o).attr("title",p):a(a(g.get(l)).find("div")[1]).html(o).attr("title",p),c.content?q.html(c.content):(a("#"+e.id+"_"+h[l].id+"_iframe").attr("src",n).width(q.width()),setTimeout(function(){a("#"+e.id+"_"+h[l].id+"_iframe").width("100%")},500)),a.extend(h[l],c)}},_bindTabs:function(b,c,d){var e=this._getInst(b),f=e.settings.data,g=this._getIndexById(f,d);f[g].bind=c;var h=a(a(b).find("li").get(g));for(var i=0;i<c.length;i++)h.bind(c[i].type,{data:f[g]},c[i].action)},_unbindTabs:function(b,c,d){var e=this._getInst(b),f=this._getIndexById(e.settings.data,d),g=e.settings.data[f].bind;for(var h in g)g[h].type===c&&a(a(b).find("li").get(f)).unbind(c,g[h].action)}}),a.fn.tabs=function(b){var c=Array.prototype.slice.call(arguments);if(typeof b=="string"){c.shift();return a.tabs["_"+b+"Tabs"].apply(a.tabs,[this[0]].concat(c))}return this.each(function(){a.tabs._attach(this,b)})},a.tabs=new d,window["DP_jQuery_"+b]=a})(jQuery)