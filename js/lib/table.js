/*
 * Copyright (C) 2011, Liyuan Li
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
(function(a){a.fn.extend({table:{version:"0.0.0.5",author:"lly219@gmail.com"}});var b=(new Date).getTime(),c="table",d=function(){this._defaults={styleClass:{lineSelectedClass:"table-lineSelected",mainClass:"table-main",bodyClass:"table-body",headerClass:"table-header",verticalLineClass:"table-verticalLine",lineHoverClass:"table-lineHover",sortClass:"table-sort",sortASCClass:"table-sortASC",sortDESCClass:"table-sortDESC",sortUnASCClass:"table-sortUnactiveASC",sortUnDESCClass:"table-sortUnactiveDESC",oddRowClass:"table-oddRow",evenRowClass:"table-evenRow",subTitleClass:"table-subTitle",subTitleShowClass:"table-subTitleShow",subTitleHideClass:"table-subTitleHide",expendRowClass:"table-expendRow"}}};a.extend(d.prototype,{_attach:function(b,d){b.id||(this.uuid++,b.id="dp"+this.uuid);var e=this._newInst(a(b));e.settings=a.extend({length:0,selectedRows:[]},d||{}),a.data(b,c,e),this._init(b)},_newInst:function(a){var b=a[0].id.replace(/([^A-Za-z0-9_])/g,"\\\\$1");return{id:b}},_getInst:function(b){try{return a.data(b,c)}catch(d){throw"Missing instance data for this table"}},_init:function(b){var c=this._getInst(b),d=c.settings;a(b).append("<div class='"+this._getDefaults(this._defaults,d,"styleClass").mainClass+"' id='"+c.id+"Table'></div>"),this._build(b)},_build:function(b){var c=this._getInst(b),d=c.settings,e=c.id,f=this._getDefaults(a.table._defaults,d,"resizable"),g=this._getDefaults(this._defaults,d,"styleClass"),h=f?"<div class='"+g.verticalLineClass+"' id='"+e+"VerticalLine'></div>":"",i=h+"<div id='"+e+"TableHeader' class='"+g.headerClass+"'></div>"+"<div id='"+e+"TableMain' class='"+g.bodyClass+"' style='height:"+d.height+"px'></div>";a("#"+e+"Table").html(i),this._buildHeader(b),d.data&&(this._buildBody(b),this._bindEvent(b)),a("#"+e+"TableHeader").width(document.getElementById(e+"TableMain").clientWidth),a(window).resize(function(){a("#"+e+"TableHeader").width(document.getElementById(e+"TableMain").clientWidth)})},_buildHeader:function(c){var d=this._getInst(c).settings,e=d.colModel,f=this._getInst(c).id,g="<table cellpadding='0' cellspacing='0' style='width:100%'><tr>";for(var h=0;h<e.length;h++){var i=f+"_"+e[h].index;e[h].minWidth?g+="<th style='min-width:"+e[h].minWidth+"px;'>":g+="<th style='width:"+e[h].width+"px;'>",e[h].type==="checkbox"?g+="<input id='"+i+"' onclick=\"DP_jQuery_"+b+".table._selectHeaderCheckbox(this);\" type='checkbox'/></th>":g+="<span id='"+i+"'>"+e[h].text?e[h].text:"</span></th>"}a("#"+f+"TableHeader").html(g+"</tr></table>")},_buildBody:function(b){var c=this._getInst(b).id,d=this._getInst(b).settings,e=d.data,f=this._getDefaults(this._defaults,d,"styleClass"),g="";for(var h=0;h<e.length;h++)e[h].groupName!=="all"&&e.length!==1&&(g+="<div  id='"+c+"SubTitle"+h+"'class='"+f.subTitleClass+"'><div class='bowknot-left "+f.subTitleShowClass+"'></div><div class='bowknot-left'>"+e[h].groupName+"</div><div class='bowknot-clear'></div></div>"),g+="<table id="+c+"SubTable"+h+" style='width:100%;' cellpadding='0' cellspacing='0'>"+this._buildData(b,e[h].groupData,h)+"</table>";a("#"+c+"TableMain").html(g)},_buildData:function(a,c,d){var e=this._getInst(a).id,f=this._getInst(a).settings,g=f.colModel,h=this._getDefaults(this._defaults,f,"styleClass"),i="";for(var j=0;j<c.length;j++){var k=c[j],l="",m="",n=h.oddRowClass;j%2===1&&(n=h.evenRowClass),l+='<tbody class="$CLASS"><tr>',k.uuuid=f.length++;for(var o=0;o<g.length;o++)for(var p in k){var q=g[o].index;if(q===p){var r=k[q],s=g[o].align?"text-align:"+g[o].align+";":"";j===0&&(g[o].minWidth?s+="min-width:"+g[o].minWidth+"px;":s+="width:"+g[o].width+"px;"),m+="<td style='"+s+"'>";if(g[o].type){var t="",u="",v="",w=e+"_"+q+"_"+d+"_"+j;k[q].value&&(u="checked='checked'",l=l.replace("$CLASS",h.lineSelectedClass+" "+n),f.selectedRows.push(k)),k[q].disabled&&(v="disabled='disabled'"),t="<input name='"+e+"_"+q+"' id='"+w+"' type='"+g[o].type+"' onclick=\"DP_jQuery_"+b+'.table._selectCheckbox(this);" '+u+" "+v+"/>",r=t}g[o].style&&(r="<div style='"+g[o].style+"'>"+r+"</div>"),m+=r+"</td>"}}i+=l.replace("$CLASS",n)+m+"</tr><tr class='bowknot-none "+h.expendRowClass+" "+n+"'>",f.expendRow&&(i+="<td colspan='"+g.length+"'>"+k[f.expendRow.index]+"</td>"),i+="</tr></tbody>"}return i},_bindEvent:function(b){var c=this._getInst(b),d=c.id,e=c.settings,f=c.settings.colModel,g=this._getDefaults(this._defaults,e,"styleClass"),h=e.data;for(var i in h){h[0].groupName!=="all"&&h.length!==1&&a("#"+d+"SubTitle"+i).click(function(){var b=a(this).find("div")[0];b.className.indexOf(g.subTitleShowClass)!=-1?(b.className=b.className.replace(g.subTitleShowClass,g.subTitleHideClass),a(this).next().hide()):(b.className=b.className.replace(g.subTitleHideClass,g.subTitleShowClass),a(this).next().show()),a("#"+d+"TableHeader").width(document.getElementById(d+"TableMain").clientWidth)});var j=e.bind?e.bind:[],k=h[i].groupData;for(var l=0;l<k.length;l++){var m=a(a("#"+d+"SubTable"+i+" tbody")[l]);for(var n=0;n<j.length;n++)m.bind(j[n].type,{groupData:k[l],bindNum:n},function(a){j[a.data.bindNum].action(a,a.data.groupData)});m.mouseover(function(){a(this).addClass(g.lineHoverClass),a(this).find("tr")[1].style.display="block"}).mouseout(function(){a(this).removeClass(g.lineHoverClass),a(this).find("tr")[1].style.display="none"});for(var o=0;o<f.length;o++)if(f[o].bind){var p=f[o].bind;for(var q=0;q<p.length;q++)a(m.find("td")[o]).bind(p[q].type,{groupData:k[l],bindNum:q},function(a){p[a.data.bindNum].action(a,a.data.groupData)})}}}},_selectHeaderCheckbox:function(b){var d=b.id.split("_")[0],e=b.id.split("_")[1],f=a("#"+d).data(c).settings,g=f.data,h=this._getDefaults(this._defaults,f,"styleClass");for(var i=0;i<g.length;i++){var j=g[i].groupData;for(var k=0;k<j.length;k++){var l=a("#"+d+"_"+e+"_"+i+"_"+k);b.checked?(l.attr("checked","checked"),f.selectedRows.push(j[k])):l.removeAttr("checked")}}b.checked?(a("#"+d+"TableMain tbody").addClass(h.lineSelectedClass),a.unique(f.selectedRows)):(a("#"+d+"TableMain tbody").removeClass(h.lineSelectedClass),f.selectedRows=[])},_selectCheckbox:function(b){var d=b.id.split("_")[0],e=b.id.split("_")[1],f=b.id.split("_")[2],g=b.id.split("_")[3],h=a("#"+d).data(c).settings,i=h.data,j=this._getDefaults(this._defaults,h,"styleClass"),k=a("#"+d+"_"+e),l=a(a("#"+d+"SubTable"+f+" tbody")[g]);if(b.checked)l.addClass(j.lineSelectedClass),h.selectedRows.push(i[f].groupData[g]);else{l.removeClass(j.lineSelectedClass);for(var m in h.selectedRows)h.selectedRows[m].uuuid===i[f].groupData[g].uuuid&&h.selectedRows.splice(m,1)}h.selectedRows.length===h.length?k.attr("checked","checked"):k.removeAttr("checked")},_getRow:function(b,c,d){var e={};for(var f in c){var g=c[f].groupData;for(var h in g)d===g[h].uuuid&&(e.data=g[h],e.$row=a(a("#"+b+"SubTable"+f+" tbody")[h]))}return e},_getDefaults:function(a,b,c){if(c==="styleClass"){if(b.theme==="default"||b.theme===undefined)return a.styleClass;b.styleClass={};for(var d in a[c])b.styleClass[d]=b.theme+"-"+a.styleClass[d]}else if(b[c]===null||b[c]===undefined)return a[c];return b[c]},_strToInt:function(a){if(!a)return!1;return parseInt(a.substring(0,a.length-2))},_updateTable:function(b,c,d){var e=this._getInst(b),f=e.id,g=e.settings;if(!d)if(c.height){var h=c.height;a("#"+f+"TableMain").height(h),g.height=h}else g.data=c.data,this._build(b);else{var i=g.data,j=g.colModel,k=this._getRow(f,i,c);a.extend(k.row,d);for(var l=0;l<j.length;l++)for(var m in d)j[l].index===m&&(k.$row.find("td")[l].innerHTML=d[m]);for(var n in d)n===g.expendRow.index&&a(k.$row.find("tr")[1]).find("td").html(d[n])}},_getRowsTable:function(a,b,c){var d=this._getInst(a),e=d.settings;if(!b)return e.selectedRows;var f=[];for(var g=0;g<e.data.length;g++){var h=e.data[g].groupData;for(var i in h)h[i][b]===c&&f.push(h[i])}return f},_destroyTable:function(b){var d=this._getInst(b);a.removeData(b,c),a("#"+d.id).remove()},_selectedTable:function(b,c){var d=this._getInst(b),e=d.id,f=d.settings,g=d.settings.data,h=this._getDefaults(this._defaults,f,"styleClass");for(var i in g){var j=g[i].groupData;for(var k in j)if(c===j[k].uuuid){f.selectedRows.push(j[k]),a.unique(f.selectedRows);var l=a(a("#"+e+"SubTable"+i+" tbody")[k]);l.addClass(h.lineSelectedClass),l.find("input").attr("checked","checked")}}},_unSelectedTable:function(b,c){var d=this._getInst(b),e=d.id,f=d.settings,g=d.settings.data,h=this._getDefaults(this._defaults,f,"styleClass");for(var i in g){var j=g[i].groupData;for(var k in j)if(c===j[k].uuuid){var l=f.selectedRows;for(var m=0;m<l.length;m++)l[m].uuuid===c&&l.splice(m,1);var n=a(a("#"+e+"SubTable"+i+" tbody")[k]);n.removeClass(h.lineSelectedClass),n.find("input").removeAttr("checked")}}}}),a.fn.table=function(b){var c=Array.prototype.slice.call(arguments);if(typeof b=="string"){c.shift();return a.table["_"+b+"Table"].apply(a.table,[this[0]].concat(c))}return this.each(function(){a.table._attach(this,b)})},a.table=new d,window["DP_jQuery_"+b]=a})(jQuery)